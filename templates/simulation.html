<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DraftU | Constructor</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Badge de Cupos */
        .seats-badge {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: #e0e0e0;
            color: #555;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .seats-badge.full {
            background-color: #ffebee;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }
        .seats-badge.warning {
            background-color: #fff8e1;
            color: #f57c00;
            border: 1px solid #ffecb3;
        }
    </style>
</head>
<body>
    <div class="builder-container">
        <header class="header-simple">
            <a href="/">
                <img src="{{ url_for('static', filename='images/DraftU2.png') }}" alt="DraftU" class="logo-small">
            </a>
        </header>
        <div class="intro-text" id="introText">
            <h2>SIMULACIÓN DE INSCRIPCIONES</h2> <p>Modo Demo: Disponibilidad en tiempo real</p>
            
            <button id="btnSimulate" onclick="simulateLiveEnrollment()" 
                    style="background: #333; border: 1px solid #FFAD4D; color: #FFAD4D; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-top: 15px; font-weight: 500;">
                <i class="fa-solid fa-bolt"></i> Simular Disponibilidad en Vivo
            </button>
        </div>
        <div class="board-canvas" id="boardCanvas">
            <div class="cards-wrapper" id="cardsWrapper">
                <div class="column expanded">
                    <div class="card-dashed" onclick="openAddSubjectModal()">
                        <div class="card-text">Agregar materia</div>
                    </div>
            
                    <div class="card-dashed" style="opacity: 0.5; pointer-events: none;">
                        <div class="card-text">Agregar profesor y<br>horarios</div>
                    </div>

                   

                </div>
            
            </div>
        </div>
        <div class="bottom-bar">
            <button class="generate-btn" onclick="submitData()">Generar horarios</button>
        </div>
    </div>
    
    <script>
        let subjectsData = [];
        let idToDelete = null;
        let currentSubjectId = null;
        let editingGroupId = null;
        const DAYS = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];

        function openAddSubjectModal() {
            document.getElementById('subjectModal').classList.add('active');
            document.getElementById('subjectNameInput').focus(); // Pone el cursor directo para escribir
        }
        function openGroupModal(subjectId, groupId = null) {
            currentSubjectId = subjectId;
            editingGroupId = groupId; // Guardamos el ID (puede ser null o un número)
            
            const modalTitle = document.querySelector('#groupModal h3');
            const inputName = document.getElementById('profName');
            const container = document.getElementById('timeBlocksContainer');
            const btnSave = document.getElementById('btnSaveGroup');

            // Limpiar formulario previo
            container.innerHTML = ''; 
            inputName.value = '';

            if (groupId === null) {
                // MODO CREAR
                modalTitle.innerText = "Nuevo Grupo";
                btnSave.innerText = "Guardar Grupo";
                addTimeRow(); // Añadir una fila vacía
            } else {
                // MODO EDITAR
                modalTitle.innerText = "Editar Grupo";
                btnSave.innerText = "Actualizar Grupo";

                // 1. Buscar los datos existentes
                const subject = subjectsData.find(s => s.id === subjectId);
                const group = subject.groups.find(g => g.id === groupId);

                // 2. Rellenar Nombre
                inputName.value = group.professor;

                // 3. Rellenar Horarios
                group.schedules.forEach(sch => {
                    // Convertimos formato "HH:MM" a inputs
                    // sch.day es 0-5
                    addTimeRow(sch.day, sch.start, sch.end);
                });
            }

            document.getElementById('groupModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            // Limpiar inputs
            if(modalId === 'subjectModal') document.getElementById('subjectNameInput').value = '';
        }
        function confirmAddSubject() {
            const nameInput = document.getElementById('subjectNameInput');
            const name = nameInput.value.trim();

            if (!name) {
                alert("Por favor escribe un nombre.");
                return;
            }

            // A. Crear objeto en nuestro JSON
            const newSubject = {
                id: Date.now(), // ID único basado en el tiempo
                name: name,
                groups: [] // Lista vacía de profesores/horarios
            };
            subjectsData.push(newSubject);
            saveCatalog();
            // B. Renderizar de nuevo el tablero
            renderBoard();

            // C. Cerrar y limpiar
            closeModal('subjectModal');
        }
/* simulation.html -> script -> renderBoard (CORREGIDO) */

        function renderBoard() {
            saveCatalog(); // Guardamos cambios por si acaso
            
            const wrapper = document.getElementById('cardsWrapper');
            wrapper.innerHTML = ''; 

            subjectsData.forEach((subject, index) => {
                // --- 1. DETECTAR SI LA MATERIA ESTÁ ACTIVA ---
                const isSubActive = subject.active !== false; 
                const subOpacityClass = isSubActive ? '' : 'inactive-item';
                const subEyeIcon = isSubActive ? 'fa-eye' : 'fa-eye-slash';
                
                const colors = ['#FFD1DC', '#D1E8FF', '#E8D1FF', '#D1FFD6']; 
                const bgColor = colors[index % colors.length];

                let groupsHTML = '';
                
                // --- AQUÍ EMPIEZA EL BUCLE DE GRUPOS ---
                if (subject.groups && subject.groups.length > 0) {
                    subject.groups.forEach(group => {
                        const isGroupActive = group.active !== false;
                        const groupOpacityClass = isGroupActive ? '' : 'inactive-item';
                        const groupEyeIcon = isGroupActive ? 'fa-eye' : 'fa-eye-slash';

                        let timeBadges = '';
                        group.schedules.forEach(sch => {
                            timeBadges += `<span class="schedule-badge">${sch.dayName} ${sch.start}-${sch.end}</span>`;
                        });

                        // --- AHORA SÍ: LÓGICA DE CUPOS (DENTRO DEL BUCLE) ---
                        if (group.seats === undefined) group.seats = 30; // Default
                        let seatClass = '';
                        let seatIcon = 'fa-users';

                        if (group.seats === 0) {
                            seatClass = 'full';
                            seatIcon = 'fa-ban';
                        } else if (group.seats <= 5) {
                            seatClass = 'warning';
                        }

                        const seatsHTML = `
                            <div class="seats-badge ${seatClass}" title="Lugares disponibles">
                                <i class="fa-solid ${seatIcon}"></i> 
                                ${group.seats}/30
                            </div>
                        `;
                        // ----------------------------------------------------

                        groupsHTML += `
                            <div class="group-card ${groupOpacityClass}">
                                <div class="group-prof">Prof. ${group.professor}</div>
                                <div class="group-schedule">
                                    ${timeBadges}
                                </div>
                                
                                <div class="group-controls">
                                    <div class="group-icon-btn" 
                                        onclick="toggleGroupActive(${subject.id}, ${group.id})"
                                        title="${isGroupActive ? 'Ocultar profesor' : 'Mostrar profesor'}">
                                        <i class="fa-solid ${groupEyeIcon}"></i>
                                    </div>
                                    
                                    <div class="group-icon-btn edit-group" 
                                        onclick="openGroupModal(${subject.id}, ${group.id})"
                                        title="Editar información">
                                        <i class="fa-solid fa-pen"></i>
                                    </div>
                                    
                                    <div class="group-icon-btn delete-group" 
                                        onclick="removeGroup(${subject.id}, ${group.id})"
                                        title="Eliminar profesor">
                                        <i class="fa-solid fa-xmark"></i>
                                    </div>
                                </div>

                                ${seatsHTML}
                            </div>
                        `;
                    });
                }

                const columnHTML = `
                    <div class="column expanded ${subOpacityClass}" id="col-${subject.id}">
                        
                        <div class="subject-header" style="background-color: ${bgColor};">
                            
                            <div class="delete-btn" onclick="event.stopPropagation(); openDeleteModal(${subject.id})" title="Eliminar materia">
                                <i class="fa-solid fa-trash-can"></i>
                            </div>

                            <h3>${subject.name}</h3>

                            <div style="display:flex; gap:10px; align-items:center;">
                                
                                <div class="header-eye-btn" 
                                    onclick="toggleSubjectActive(${subject.id})"
                                    title="${isSubActive ? 'Ocultar materia temporalmente' : 'Reactivar materia'}">
                                    <i class="fa-solid ${subEyeIcon}"></i>
                                </div>

                                <div class="accordion-toggle" onclick="toggleAccordion(${subject.id})">
                                    <i class="fa-solid fa-chevron-down"></i>
                                </div>
                            </div>

                        </div>

                        ${groupsHTML}

                        <div class="card-dashed" onclick="openGroupModal(${subject.id})">
                            <div class="card-text">Agregar profesor y<br>horarios</div>
                        </div>
                    </div>
                `;
                wrapper.innerHTML += columnHTML;
            });

            // Columna de "Agregar Materia"
            const addColumnHTML = `
                <div class="column expanded" id="addSubjectColumn">
                    <div class="card-dashed" onclick="openAddSubjectModal()">
                        <div class="card-text">Agregar materia</div>
                    </div>
                </div>
            `;
            wrapper.innerHTML += addColumnHTML;
        }
        function openDeleteModal(id) {
            idToDelete = id; 
            document.getElementById('deleteModal').classList.add('active');
        }
        function simulateLiveEnrollment() {
            subjectsData.forEach(sub => {
                sub.groups.forEach(group => {
                    // Probabilidades: 30% lleno, 30% casi lleno, 40% libre
                    const luck = Math.random();
                    if (luck < 0.3) {
                        group.seats = 0; // LLENO TOTAL
                    } else if (luck < 0.6) {
                        group.seats = Math.floor(Math.random() * 5) + 1; // 1-5 lugares
                    } else {
                        group.seats = Math.floor(Math.random() * 15) + 15; // 15-30 lugares
                    }
                });
            });
            renderBoard();
            
            // Efecto visual en el botón
            const btn = document.getElementById('btnSimulate');
            btn.innerHTML = '<i class="fa-solid fa-check"></i> ¡Sistema Actualizado!';
            setTimeout(() => {
                btn.innerHTML = '<i class="fa-solid fa-bolt"></i> Simular Disponibilidad en Vivo';
            }, 2000);
        }
        
        function confirmDeleteSubject() {
            if (idToDelete !== null) {
                subjectsData = subjectsData.filter(sub => sub.id !== idToDelete);
                saveCatalog();
                renderBoard();
        
                closeModal('deleteModal');
                idToDelete = null;
            }
        }
        // 2. AGREGAR FILA DE HORARIO
        function addTimeRow(savedDay = null, savedStart = null, savedEnd = null) {
            const container = document.getElementById('timeBlocksContainer');
            
            // VARIABLES POR DEFECTO (Para nueva fila manual)
            let defaultStart = '';
            let defaultEnd = '';
            let defaultDay = '0'; 

            // SI NO NOS PASAN DATOS (Es manual), INTENTAMOS COPIAR DEL ANTERIOR
            if (savedDay === null) {
                const existingRows = container.getElementsByClassName('time-row');
                if (existingRows.length > 0) {
                    const lastRow = existingRows[existingRows.length - 1];
                    
                    const inputs = lastRow.querySelectorAll('.input-time');
                    if (inputs.length >= 2) {
                        defaultStart = inputs[0].value;
                        defaultEnd = inputs[1].value;
                    }
                    
                    const daySelect = lastRow.querySelector('.input-day');
                    if (daySelect) defaultDay = daySelect.value;
                }
            } else {
                // SI NOS PASAN DATOS (Modo Edición), USAMOS ESOS
                defaultDay = savedDay;
                defaultStart = savedStart;
                defaultEnd = savedEnd;
            }

            const div = document.createElement('div');
            div.className = 'time-row';
            
            div.innerHTML = `
                <select class="input-day">
                    <option value="0">Lunes</option>
                    <option value="1">Martes</option>
                    <option value="2">Miércoles</option>
                    <option value="3">Jueves</option>
                    <option value="4">Viernes</option>
                    <option value="5">Sábado</option>
                </select>
                
                <input type="time" class="input-time" value="${defaultStart}" required>
                <span style="align-self:center">-</span>
                <input type="time" class="input-time" value="${defaultEnd}" required>
                
                <button class="btn-remove-row" type="button" onclick="removeTimeRow(this)">
                    <i class="fa-solid fa-trash"></i>
                </button>
            `;
            
            // Asignar el día seleccionado
            div.querySelector('.input-day').value = defaultDay;
            
            container.appendChild(div);
        }

        // 3. BORRAR FILA DE HORARIO
        function removeTimeRow(btn) {
            const row = btn.closest('.time-row');
            if (row) row.remove();
        }
        function removeGroup(subjectId, groupId) {
            // 1. Encontrar la materia
            const subject = subjectsData.find(s => s.id === subjectId);
            if (subject) {
                // 2. Filtrar los grupos para quitar el que coincida con groupId
                subject.groups = subject.groups.filter(g => g.id !== groupId);
                // 3. Volver a pintar
                saveCatalog();
                renderBoard();
            }
        }

       
        function toggleAccordion(subjectId) {
            const column = document.getElementById(`col-${subjectId}`);
            // Simplemente quitamos o ponemos la clase 'expanded'
            column.classList.toggle('expanded');
        }
        function saveGroup() {
            const profName = document.getElementById('profName').value.trim();
            if (!profName) {
                alert("Ingresa el nombre del profesor.");
                return;
            }

            // Recopilar Horarios (Igual que antes)
            const rows = document.querySelectorAll('.time-row');
            const schedules = [];
            
            for (let row of rows) {
                const day = parseInt(row.querySelector('.input-day').value);
                const start = row.querySelectorAll('.input-time')[0].value;
                const end = row.querySelectorAll('.input-time')[1].value;

                if (!start || !end) {
                    alert("Completa todos los horarios.");
                    return;
                }
                if (start >= end) {
                    alert("La hora de inicio debe ser menor a la de fin.");
                    return;
                }

                const daysMap = ["LUN", "MAR", "MIÉ", "JUE", "VIE", "SÁB"];
                schedules.push({
                    day: day,
                    dayName: daysMap[day],
                    start: start,
                    end: end
                });
            }

            // --- LÓGICA NUEVA: GUARDAR O ACTUALIZAR ---
            const subject = subjectsData.find(s => s.id === currentSubjectId);

            if (editingGroupId === null) {
                // CREAR NUEVO
                const newGroup = {
                    id: Date.now(),
                    professor: profName,
                    schedules: schedules,
                    active: true
                };
                subject.groups.push(newGroup);
            } else {
                // ACTUALIZAR EXISTENTE
                const group = subject.groups.find(g => g.id === editingGroupId);
                group.professor = profName;
                group.schedules = schedules;
            }
            // ------------------------------------------

            closeModal('groupModal');
            renderBoard();
        }

        // templates/builder.html - Script

        async function submitData() {
            const btn = document.querySelector('.generate-btn'); // <--- FALTABA ESTO
            const originalText = btn.innerText;                  // <--- Y ESTO
    
            // Cambiar estado visual del botón
            btn.innerText = "Pensando...";
            btn.disabled = true;
            btn.style.backgroundColor = "#ccc";
            // 1. Validar que haya datos
            const activePayload = subjectsData
                    // A. Filtrar materias ocultas
                    .filter(sub => sub.active !== false) 
                    .map(sub => {
                        // B. Crear copia de la materia
                        return {
                            ...sub,
                            // C. Filtrar grupos ocultos dentro de la materia
                            groups: sub.groups.filter(g => g.active !== false && g.seats > 0)
                        };
                    })
                    // D. Seguridad: Si una materia se quedó sin grupos visibles, la quitamos también
                    // (Porque el algoritmo fallaría si le mandas una materia vacía)
                    .filter(sub => sub.groups.length > 0);

            // Validar sobre los datos FILTRADOS
            if (activePayload.length === 0) {
                alert("No hay materias activas para generar horario. Activa alguna.");
                return;
            }

            showLoadingScreen();

            try {
                // 3. Enviar datos a Python
                const response = await fetch('/generate-schedule', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(activePayload)
                });

                const result = await response.json();

                setTimeout(() => {
                    hideLoadingScreen(); 
                            
                    if (result.status === "error") {
                        alert("Error: " + result.message);
                    } else {
                        localStorage.setItem('schedulesResult', JSON.stringify(result));
                        window.location.href = "/results";
                    }
                }, 3000); 

            } catch (error) {
                console.error("Error:", error);
                alert("Error de conexión con el servidor.");
            } finally {
                // Restaurar botón
                btn.innerText = originalText;
                btn.disabled = false;
                btn.style.backgroundColor = "#FFAD4D";
            }
        }

      
        let textInterval;

        const LOADING_PHRASES = [
            "Leyendo tus preferencias...",
            "Analizando combinaciones posibles...",
            "Detectando conflictos de horario...",
            "Optimizando tus tiempos libres...",
            "Dibujando el horario perfecto..."
        ];

        function showLoadingScreen() {
            const overlay = document.getElementById('loadingOverlay');
            const textElement = document.getElementById('loadingText');
            const zone = document.getElementById('fallingLinesZone');
            
            overlay.classList.add('active');
            
            let phraseIndex = 0;
            textElement.innerText = LOADING_PHRASES[0];
            
            textInterval = setInterval(() => {
                phraseIndex = (phraseIndex + 1) % LOADING_PHRASES.length;
                // Efecto suave de desvanecer texto podría ir aquí, pero cambio directo funciona bien
                textElement.innerText = LOADING_PHRASES[phraseIndex];
            }, 1500); // Cambia cada 1.5 segundos
        }

        function hideLoadingScreen() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
            
            // Limpiar intervalos para ahorrar memoria
            clearInterval(textInterval);
            
        }

        function saveCatalog() {
        // Convertimos el array a texto y lo guardamos en el navegador
        localStorage.setItem('draftu_catalog', JSON.stringify(subjectsData));
        }
        function loadCatalog() {
            const savedData = localStorage.getItem('draftu_catalog');
            if (savedData) {
                // Si existe data guardada, la recuperamos
                subjectsData = JSON.parse(savedData);
                // Y repintamos el tablero automáticamente
                renderBoard();
            }
        }
        window.addEventListener('load', () => {
            loadCatalog();
        });
        function toggleSubjectActive(subjectId) {
            const subject = subjectsData.find(s => s.id === subjectId);
            if (subject) {
                // Si no existe la propiedad, asumimos true y la invertimos a false
                if (subject.active === undefined) subject.active = true;
                subject.active = !subject.active;
                renderBoard(); // Repintar
            }
        }

        // Toggle Grupo Específico
        function toggleGroupActive(subjectId, groupId) {
            const subject = subjectsData.find(s => s.id === subjectId);
            if (subject) {
                const group = subject.groups.find(g => g.id === groupId);
                if (group) {
                    if (group.active === undefined) group.active = true;
                    group.active = !group.active;
                    renderBoard(); // Repintar
                }
            }
        }

    </script>
    {% include 'loading.html' %}
</body>
<div id="subjectModal" class="modal-overlay">
    <div class="modal-card">
        <h3>Nueva Materia</h3>
        <p>Ingresa el nombre de la asignatura</p>
        
        <input type="text" id="subjectNameInput" class="modal-input" placeholder="Ej. Cálculo Vectorial" autocomplete="off">
        
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('subjectModal')">Cancelar</button>
            <button class="btn-confirm" onclick="confirmAddSubject()">Crear Materia</button>
        </div>
    </div>
</div>
<div id="deleteModal" class="modal-overlay">
    <div class="modal-card">
        <div style="font-size: 3rem; color: #ff6b6b; margin-bottom: 15px;">
            <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        
        <h3>¿Estás seguro?</h3>
        <p style="margin-bottom: 25px;">Se eliminará esta materia y todos los grupos que hayas configurado.</p>
        
        <div class="modal-actions">
            <button class="btn-cancel" onclick="closeModal('deleteModal')">Cancelar</button>
            <button class="btn-confirm" onclick="confirmDeleteSubject()" style="background-color: #ff6b6b;">Sí, eliminar</button>
        </div>
    </div>
</div>
<div id="groupModal" class="modal-overlay">
    <div class="modal-card" style="width: 500px;"> 
        <h3>Nuevo Grupo</h3> <p>Configura el profesor y sus horarios</p>

        <input type="text" id="profName" class="modal-input" placeholder="Nombre del Profesor (Ej. Michel Bechara)" autocomplete="off">

        <div style="text-align: left; margin-bottom: 10px;">
            <label style="font-size: 0.9rem; color: #666; margin-left: 5px;">Horarios de clase:</label>
        </div>
        
        <div id="timeBlocksContainer" class="time-blocks-container">
            </div>

        <button type="button" class="btn-add-time" onclick="addTimeRow()">
            <i class="fa-solid fa-plus"></i> Agregar otro horario
        </button>
        
        <div class="modal-actions" style="margin-top: 30px;">
            <button class="btn-cancel" onclick="closeModal('groupModal')">Cancelar</button>
            
            <button id="btnSaveGroup" class="btn-confirm" onclick="saveGroup()">Guardar Grupo</button>
        </div>
    </div>
</div>
</html>